<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Primary SEO and Sharing Information -->
    <title>LLM Model Comparison by EndemicMedia</title>
    <meta name="description" content="Compare large language models (LLMs) easily with Pollinations' models.">
    <meta name="keywords" content="LLM, comparison tool, Pollinations.ai, AI models, benchmarking">
    <meta name="author" content="Pollinations.ai">

    <!-- Open Graph (Facebook, LinkedIn) -->
    <meta property="og:title" content="LLM Model Comparison for Pollinations.ai">
    <meta property="og:description" content="Compare the performance of large language models like GPT, LLaMA, DeepSeek R1 and more.">
    <meta property="og:image" content="https://image.pollinations.ai/prompt/og%3Aimage%20sharing%20thumbnail%20for%20AI%20LLM%20comparison%20tool?enhance=true&nologo=true&model=flux">
    <meta property="og:url" content="https://endemicmedia.github.io/FLARE/llm-comparison-tool/">
    <meta property="og:type" content="website">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="LLM Model Comparison Tool">
    <meta name="twitter:description" content="Find the best large language model for your needs. Real-time results!">
    <meta name="twitter:image" content="https://image.pollinations.ai/prompt/og%3Aimage%20sharing%20thumbnail%20for%20AI%20LLM%20comparison%20tool?enhance=true&nologo=true&model=flux">

    <!-- Additional sharing metadata -->
    <meta property="whatsapp:description" content="Compare AI models intuitively!">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    
    <!-- SVG Icon -->
    <link rel="apple-touch-icon" href="favicon.svg">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use class-based dark mode
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .markdown-content code {
            background-color: #f4f4f4;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }
        .markdown-content pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .markdown-content blockquote {
            border-left: 4px solid #ccc;
            padding-left: 10px;
            color: #666;
            margin: 0;
        }
        /* Dark mode markdown styles */
        .dark .markdown-content code {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark .markdown-content pre {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark .markdown-content blockquote {
            border-left: 4px solid #4a5568;
            color: #a0aec0;
        }
        .model-status-queued {
            color: #718096; /* gray */
            font-style: italic;
        }
        .model-status-loading {
            color: #3182ce; /* blue */
            font-style: italic;
        }
        .model-status-completed {
            /*color: #48bb78; /* green */
        }
        .model-status-error {
            color: #e53e3e; /* red */
        }
        .fastest-model {
            border: 2px solid #48bb78 !important; /* Green border for fastest models */
        }
        /* Fullscreen modal styles */
        #fullscreen-modal {
            transition: opacity 0.3s ease;
        }
        #fullscreen-modal .markdown-content {
            max-width: 100%;
            word-wrap: break-word;
        }
        /* Fixed font size for fullscreen content */
        #fullscreen-content {
            font-size: 1.125rem !important; /* Equivalent to text-lg */
        }
        
        /* Custom slider styles */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: grab;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
        }
        
        input[type="range"]::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(1.15);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: grab;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
        }
        
        input[type="range"]::-moz-range-thumb:active {
            cursor: grabbing;
            transform: scale(1.15);
        }
        
        .dark input[type="range"]::-webkit-slider-thumb {
            background: #60a5fa;
            border-color: #1f2937;
        }
        
        .dark input[type="range"]::-moz-range-thumb {
            background: #60a5fa;
            border-color: #1f2937;
        }
        
        /* Parameter info tooltip styles */
        .param-info {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            margin-left: 4px;
            border-radius: 50%;
            background: #9ca3af;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            flex-shrink: 0;
        }
        
        .dark .param-info {
            background: #6b7280;
        }
        
        .param-info:hover {
            background: #3b82f6;
        }
        
        .dark .param-info:hover {
            background: #60a5fa;
        }
        
        .param-info .tooltip {
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            margin-left: 12px;
            padding: 10px 14px;
            background: #1f2937;
            color: white;
            font-size: 12px;
            font-weight: normal;
            line-height: 1.6;
            border-radius: 6px;
            white-space: normal;
            width: 320px;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .param-info:hover .tooltip {
            opacity: 1;
        }
        
        .param-info .tooltip::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: #1f2937;
        }
        
        .tooltip-default {
            display: block;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-style: italic;
            opacity: 0.9;
            font-size: 11px;
        }
        
        .tooltip-example {
            display: block;
            margin-top: 6px;
            padding: 6px 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            font-size: 11px;
            font-family: monospace;
        }
        
        .tooltip-example strong {
            color: #60a5fa;
        }
        
        /* Matrix mode styles */
        .matrix-mode .model-parameters-section {
            display: none;
        }
        
        /* Parameters positioning */
        .model-parameters-section {
            position: relative;
        }
        
        #parameters-expanded {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            margin-top: 4px;
            min-width: 400px;
        }
        
        .matrix-card {
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        
        .matrix-card .parameter-label {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        /* Model name click indicator */
        .cursor-pointer:hover {
            color: #3b82f6 !important;
            text-decoration: underline;
        }
        
        /* Override for dropdown items - no underline */
        #prompt-dropdown .cursor-pointer:hover {
            text-decoration: none !important;
        }
        
        /* Maintain text color in light and dark modes */
        #prompt-dropdown .cursor-pointer:hover {
            color: #111827 !important; /* gray-900 for light mode */
        }
        
        .dark #prompt-dropdown .cursor-pointer:hover {
            color: #ffffff !important; /* white for dark mode */
        }
        
        /* Model disabled state */
        .model-disabled {
            opacity: 0.3;
            pointer-events: none;
            filter: grayscale(100%);
            transition: all 0.3s ease;
        }
        
        .model-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .model-card:hover:not(.model-disabled-container) {
            transform: scale(1.02);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .model-disabled-container {
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.3s ease;
        }
        
        .model-disabled-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            opacity: 1;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23ef4444' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .dark .model-disabled-container::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23dc2626' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636'/%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col">
    <div class="fixed top-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-md z-10">
        <div class="max-w-6xl mx-auto p-4">
            <div class="grid grid-cols-12 gap-4 items-center mb-4">
                <!-- Title and Credit -->
                <div class="col-span-12 md:col-span-7 lg:col-span-8">
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white">
                        Pollinations.ai Model Comparison 
                        <a href="https://github.com/EndemicMedia/FLARE" class="block md:inline text-sm text-orange-400 dark:text-orange-400">
                            by EndemicMedia
                        </a>
                    </h1>
                </div>
                
                <!-- Control Buttons -->
                <div class="col-span-12 md:col-span-5 lg:col-span-4">
                    <div class="flex items-center justify-end space-x-2">
                        <!-- Toggle All Models Button -->
                        <button 
                            id="toggle-all-btn" 
                            class="bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white px-2 py-1 rounded text-xs flex items-center space-x-1"
                            title="Enable/Disable all models"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>All</span>
                        </button>
                        
                        <!-- BYOP Button -->
                        <button 
                            id="byop-btn" 
                            class="bg-purple-500 hover:bg-purple-600 dark:bg-purple-600 dark:hover:bg-purple-700 text-white px-2 py-1 rounded text-xs"
                            title="Bring Your Own Pollen - Use your API key"
                        >
                            üå∏ BYOP
                        </button>
                        
                        <!-- Timeout Dropdown -->
                        <div class="flex items-center space-x-1">
                            <label for="timeout-dropdown" class="text-xs text-gray-700 dark:text-gray-300">
                                Timeout:
                            </label>
                            <select
                                id="timeout-dropdown"
                                class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white px-2 py-1 text-xs rounded"
                                aria-label="Set timeout value"
                            >
                                <option value="3000">3s</option>
                                <option value="5000">5s</option>
                                <option value="10000">10s</option>
                                <option value="15000">15s</option>
                                <option value="30000" selected>30s</option>
                                <option value="60000">60s</option>
                            </select>
                        </div>
                        
                        <button id="font-decrease-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white px-2 py-1 rounded text-sm">-</button>
                        <button id="font-increase-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white px-2 py-1 rounded text-sm">+</button>
                        <button 
                            id="theme-toggle" 
                            class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-white px-2 py-1 rounded"
                        >
                            üåì
                        </button>
                    </div>
                </div>
            </div>
            <div>
                <!-- <label for="prompt-input" class="block text-gray-700 dark:text-gray-300 font-bold mb-2">Enter Prompt</label> -->
                <div class="flex space-x-2">
                    <!-- Model Parameters Toggle Button -->
                    <div class="model-parameters-section">
                        <!-- Collapsible Parameters -->
                        <button 
                            id="parameters-toggle-btn"
                            class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 hover:bg-gray-50 dark:hover:bg-gray-600 h-[42px] flex items-center justify-center"
                            title="Show/Hide model parameters"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                            </svg>
                        </button>
                        
                        <!-- Expanded Parameters -->
                        <div id="parameters-expanded" class="hidden bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700 shadow-lg">
                            <button 
                                id="parameters-collapse-btn"
                                class="w-full flex items-center justify-between text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white mb-3"
                                title="Hide model parameters"
                            >
                                <span class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                                    </svg>
                                    Parameters
                                </span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                            <div class="grid grid-cols-1 gap-y-3">
                                <!-- Temperature -->
                                <div class="flex items-center space-x-3">
                                    <label for="temperature-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0 flex items-center">
                                        Temp:
                                        <span class="param-info">
                                            i
                                            <span class="tooltip">
                                                Controls randomness in word selection.<br><br>
                                                Lower values make output more focused and predictable.<br>
                                                Higher values make it more creative and varied.
                                                <span class="tooltip-example">
                                                    <strong>0.0:</strong> "The sunset painted the sky orange."<br>
                                                    <strong>2.0:</strong> "Blazing amber hues danced wildly!"
                                                </span>
                                                <span class="tooltip-default">Default: 0.7</span>
                                            </span>
                                        </span>
                                    </label>
                                    <input
                                        type="range"
                                        id="temperature-slider"
                                        min="0"
                                        max="2"
                                        step="0.1"
                                        value="0.7"
                                        class="flex-grow h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                    />
                                    <span id="temperature-value" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-12 flex-shrink-0 text-right">0.7</span>
                                </div>

                                <!-- Top P -->
                                <div class="flex items-center space-x-3">
                                    <label for="top-p-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0 flex items-center">
                                        Top-P:
                                        <span class="param-info">
                                            i
                                            <span class="tooltip">
                                                Limits token selection to top cumulative probability.<br><br>
                                                Lower values = only most likely words.<br>
                                                Higher values = more word choices available.
                                                <span class="tooltip-example">
                                                    <strong>0.1:</strong> "The sky turned orange and red."<br>
                                                    <strong>1.0:</strong> "The heavens blazed crimson magnificently."
                                                </span>
                                                <span class="tooltip-default">Default: 1.0</span>
                                            </span>
                                        </span>
                                    </label>
                                    <input
                                        type="range"
                                        id="top-p-slider"
                                        min="0"
                                        max="1"
                                        step="0.05"
                                        value="1"
                                        class="flex-grow h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                    />
                                    <span id="top-p-value" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-12 flex-shrink-0 text-right">1.0</span>
                                </div>

                                <!-- Max Tokens -->
                                <div class="flex items-center space-x-3">
                                    <label for="max-tokens-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0 flex items-center">
                                        Max:
                                        <span class="param-info">
                                            i
                                            <span class="tooltip">
                                                Maximum response length in tokens.<br><br>
                                                (~4 characters = 1 token)<br>
                                                Controls how long the response can be.
                                                <span class="tooltip-example">
                                                    <strong>50:</strong> "The sky was orange."<br>
                                                    <strong>500:</strong> "The sky transformed into..."
                                                </span>
                                                <span class="tooltip-default">Default: 500 tokens</span>
                                            </span>
                                        </span>
                                    </label>
                                    <input
                                        type="range"
                                        id="max-tokens-slider"
                                        min="50"
                                        max="4000"
                                        step="50"
                                        value="500"
                                        class="flex-grow h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                    />
                                    <span id="max-tokens-value" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-12 flex-shrink-0 text-right">500</span>
                                </div>

                                <!-- Seed -->
                                <div class="flex items-center space-x-3">
                                    <label for="seed-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0 flex items-center">
                                        Seed:
                                        <span class="param-info">
                                            i
                                            <span class="tooltip">
                                                Controls randomness seed for reproducibility.<br><br>
                                                Same seed + parameters = same response.<br>
                                                Set to 0 for random output each time.
                                                <span class="tooltip-example">
                                                    <strong>0:</strong> Different response each time<br>
                                                    <strong>1234:</strong> Always same response
                                                </span>
                                                <span class="tooltip-default">Default: random (0)</span>
                                            </span>
                                        </span>
                                    </label>
                                    <input
                                        type="range"
                                        id="seed-slider"
                                        min="0"
                                        max="9999"
                                        step="1"
                                        value="0"
                                        class="flex-grow h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                    />
                                    <span id="seed-value" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-12 flex-shrink-0 text-right">rand</span>
                                </div>

                                <!-- Frequency Penalty -->
                                <div class="flex items-center space-x-3">
                                    <label for="frequency-penalty-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0 flex items-center">
                                        Freq:
                                        <span class="param-info">
                                            i
                                            <span class="tooltip">
                                                Reduces word repetition based on frequency.<br><br>
                                                Higher values discourage using same words.<br>
                                                Useful to avoid repetitive writing.
                                                <span class="tooltip-example">
                                                    <strong>0.0:</strong> "The blue blue sky was very blue."<br>
                                                    <strong>2.0:</strong> "The azure sky was quite cerulean."
                                                </span>
                                                <span class="tooltip-default">Default: 0.0 (off)</span>
                                            </span>
                                        </span>
                                    </label>
                                    <input
                                        type="range"
                                        id="frequency-penalty-slider"
                                        min="0"
                                        max="2"
                                        step="0.1"
                                        value="0"
                                        class="flex-grow h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                    />
                                    <span id="frequency-penalty-value" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-12 flex-shrink-0 text-right">0.0</span>
                                </div>

                                <!-- Presence Penalty -->
                                <div class="flex items-center space-x-3">
                                    <label for="presence-penalty-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0 flex items-center">
                                        Pres:
                                        <span class="param-info">
                                            i
                                            <span class="tooltip">
                                                Encourages discussing new topics.<br><br>
                                                Penalizes already-mentioned words.<br>
                                                Pushes model toward fresh ideas.
                                                <span class="tooltip-example">
                                                    <strong>0.0:</strong> "The sunset was beautiful, beautiful..."<br>
                                                    <strong>2.0:</strong> "The sunset was beautiful, then gorgeous..."
                                                </span>
                                                <span class="tooltip-default">Default: 0.0 (off)</span>
                                            </span>
                                        </span>
                                    </label>
                                    <input
                                        type="range"
                                        id="presence-penalty-slider"
                                        min="0"
                                        max="2"
                                        step="0.1"
                                        value="0"
                                        class="flex-grow h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                    />
                                    <span id="presence-penalty-value" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-12 flex-shrink-0 text-right">0.0</span>
                                </div>

                                <!-- Repetition Penalty -->
                                <div class="flex items-center space-x-3">
                                    <label for="repetition-penalty-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0 flex items-center">
                                        Rep:
                                        <span class="param-info">
                                            i
                                            <span class="tooltip">
                                                Alternative repetition control (open models).<br><br>
                                                Penalizes repeated tokens differently.<br>
                                                Similar to frequency penalty, different math.
                                                <span class="tooltip-example">
                                                    <strong>0.0:</strong> "So beautiful, so very beautiful."<br>
                                                    <strong>2.0:</strong> "Beautiful, stunning, magnificent."
                                                </span>
                                                <span class="tooltip-default">Default: 0.0 (off)</span>
                                            </span>
                                        </span>
                                    </label>
                                    <input
                                        type="range"
                                        id="repetition-penalty-slider"
                                        min="0"
                                        max="2"
                                        step="0.1"
                                        value="0"
                                        class="flex-grow h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                    />
                                    <span id="repetition-penalty-value" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-12 flex-shrink-0 text-right">0.0</span>
                                </div>

                                <!-- Top K -->
                                <div class="flex items-center space-x-3">
                                    <label for="top-k-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0 flex items-center">
                                        Top-K:
                                        <span class="param-info">
                                            i
                                            <span class="tooltip">
                                                Limits selection to K most likely tokens.<br><br>
                                                Lower values = more focused output.<br>
                                                Set to 0 to disable filtering.
                                                <span class="tooltip-example">
                                                    <strong>10:</strong> "The sun sets beautifully daily."<br>
                                                    <strong>100:</strong> "The sun descends magnificently."
                                                </span>
                                                <span class="tooltip-default">Default: off (0)</span>
                                            </span>
                                        </span>
                                    </label>
                                    <input
                                        type="range"
                                        id="top-k-slider"
                                        min="0"
                                        max="100"
                                        step="1"
                                        value="0"
                                        class="flex-grow h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                    />
                                    <span id="top-k-value" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-12 flex-shrink-0 text-right">off</span>
                                </div>

                                <!-- Min P -->
                                <div class="flex items-center space-x-3">
                                    <label for="min-p-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0 flex items-center">
                                        Min-P:
                                        <span class="param-info">
                                            i
                                            <span class="tooltip">
                                                Minimum probability threshold for tokens.<br><br>
                                                Higher values = more confident choices.<br>
                                                Filters out unlikely words.
                                                <span class="tooltip-example">
                                                    <strong>0.0:</strong> "Perhaps maybe possibly uncertain."<br>
                                                    <strong>0.2:</strong> "Clearly definitely certain."
                                                </span>
                                                <span class="tooltip-default">Default: 0.0 (off)</span>
                                            </span>
                                        </span>
                                    </label>
                                    <input
                                        type="range"
                                        id="min-p-slider"
                                        min="0"
                                        max="1"
                                        step="0.05"
                                        value="0"
                                        class="flex-grow h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"
                                    />
                                    <span id="min-p-value" class="text-sm font-medium text-gray-700 dark:text-gray-300 w-12 flex-shrink-0 text-right">0.00</span>
                                </div>
                            </div>
                            
                            <!-- Reset Button -->
                            <button 
                                id="parameters-reset-btn"
                                class="mt-3 w-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-sm font-medium transition-colors"
                                title="Reset to default values"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Reset to Defaults
                            </button>
                        </div>
                    </div>
                    
                    <select 
                        id="system-context" 
                        class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <!-- dynamically populated from system.json -->
                    </select>
                    <div id="prompt-input-container" class="relative flex-grow">
                        <input 
                            type="text" 
                            id="prompt-input" 
                            list="prompt-history"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Enter your prompt here..."
                        >
                        <datalist id="prompt-history">
                            <!-- Dynamically populated with previous prompts -->
                        </datalist>
                        <!-- Custom dropdown for better browser support -->
                        <div id="prompt-dropdown" class="absolute top-full left-0 right-0 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg z-50 max-h-48 overflow-y-auto hidden">
                            <!-- Dynamically populated dropdown items -->
                        </div>
                    </div>
                    <button 
                        id="submit-btn" 
                        class="bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                    >
                        Submit
                    </button>
                    <button 
                        id="cancel-btn" 
                        class="bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 hidden"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="models-container" class="p-4 pt-48 overflow-y-auto">
        <!-- Multi-model view -->
        <div id="multi-model-view" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
            <!-- Model results will be dynamically populated here -->
        </div>
        
        <!-- Matrix view -->
        <div id="matrix-view" class="hidden">
            <!-- Matrix results will be dynamically populated here -->
        </div>
    </div>

    <!-- Model Info Tooltip -->
    <div 
        id="model-tooltip" 
        class="fixed hidden p-3 bg-gray-800 dark:bg-gray-900 text-white text-xs rounded-lg shadow-xl border border-gray-600 text-left w-64 pointer-events-none z-[9999]"
    ></div>

    <!-- Fullscreen Modal -->
    <div 
        id="fullscreen-modal" 
        class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4"
    >
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto relative">
            <div class="absolute top-4 right-4 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white flex space-x-2"> 
                <button 
                    class="copy-btn"
                    title="Copy model output"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                </button>
                <button 
                    id="close-fullscreen-btn" 
                    class=""
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <div>
                    <h2 
                        id="fullscreen-model-name" 
                        class="text-xl font-semibold text-gray-800 dark:text-white"
                    ></h2>
                    <p 
                        id="fullscreen-model-stats" 
                        class="text-sm text-gray-500 dark:text-gray-400"
                    ></p>
                </div>
            </div>
            <div 
                id="fullscreen-content" 
                class="markdown-content p-8 text-lg dark:text-white"
            ></div>
        </div>
    </div>

    <!-- BYOP Modal -->
    <div 
        id="byop-modal" 
        class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4"
    >
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full p-6 relative">
            <button 
                id="close-byop-btn" 
                class="absolute top-4 right-4 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">üå∏ Bring Your Own Pollen</h2>
            
            <div class="mb-4">
                <p class="text-gray-700 dark:text-gray-300 mb-2">Current API Key Status:</p>
                <div id="api-key-status" class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span id="key-display" class="font-mono text-sm text-gray-600 dark:text-gray-400">Loading...</span>
                        <span id="key-type-badge" class="text-xs px-2 py-1 rounded"></span>
                    </div>
                    <div id="balance-display" class="text-sm text-gray-500 dark:text-gray-400 mt-2"></div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-gray-800 dark:text-white mb-2">Option 1: Use Pollinations OAuth (Recommended)</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        Connect your Pollinations account to use your own pollen balance. This creates a temporary API key for this app.
                    </p>
                    <button 
                        id="oauth-connect-btn" 
                        class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition duration-300 w-full"
                    >
                        Connect with Pollinations
                    </button>
                </div>
                
                <div class="border-t border-gray-300 dark:border-gray-600 pt-4">
                    <h3 class="font-semibold text-gray-800 dark:text-white mb-2">Option 2: Enter Your API Key</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        Already have an API key? Enter it below. Get one at <a href="https://enter.pollinations.ai" target="_blank" class="text-blue-500 hover:underline">enter.pollinations.ai</a>
                    </p>
                    <div class="flex space-x-2 mb-3">
                        <input 
                            type="text" 
                            id="manual-api-key" 
                            placeholder="pk_... or sk_..." 
                            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <button 
                            id="save-api-key-btn" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-300"
                        >
                            Save
                        </button>
                    </div>
                    <button 
                        id="clear-api-key-btn" 
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300 w-full"
                    >
                        üóëÔ∏è Clear My API Key from Browser
                    </button>
                </div>
                
                <div class="border-t border-gray-300 dark:border-gray-600 pt-4">
                    <button 
                        id="reset-api-key-btn" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-300 w-full"
                    >
                        Reset to Default Key
                    </button>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                <p class="text-xs text-blue-800 dark:text-blue-200">
                    <strong>Why BYOP?</strong> With your own API key, you pay for your usage directly. No API costs for the app developer, and you control your spending.
                </p>
            </div>
        </div>
    </div>

    <script>
        const MODELS_URL = 'https://gen.pollinations.ai/v1/models';
        const CHAT_URL = 'https://gen.pollinations.ai/v1/chat/completions';
        const MAX_PROMPT_HISTORY = 20; // Maximum number of prompts to store
        var SYSTEM_PROMPTS

        // Encoded default API key (obfuscated for basic protection)
        const _k = 'R3FOWmUzWU1ZT1dUNTZOZl9rcA==';
        
        // Decode the API key
        function _d(e) {
            try {
                return atob(e).split('').reverse().join('');
            } catch(err) {
                console.error('Key decode error');
                return '';
            }
        }
        
        const DEFAULT_API_KEY = _d(_k);
        
        // Get API key from URL hash (BYOP) or localStorage or use default
        function getApiKey() {
            // Check URL hash first (from BYOP redirect)
            const urlParams = new URLSearchParams(window.location.hash.slice(1));
            const hashApiKey = urlParams.get('api_key');
            if (hashApiKey) {
                // Store in localStorage and clear from URL
                localStorage.setItem('userApiKey', hashApiKey);
                window.location.hash = '';
                return hashApiKey;
            }
            
            // Check localStorage for user's API key
            const storedKey = localStorage.getItem('userApiKey');
            if (storedKey) {
                return storedKey;
            }
            
            // Fall back to default key
            return DEFAULT_API_KEY;
        }

        // Matrix mode state
        let currentMode = 'multi'; // 'multi' or 'matrix'
        let selectedModel = null;
        let allModels = [];
        
        // Model enabled/disabled state (track by model name)
        const disabledModels = new Set();
        
        // Load disabled models from localStorage
        function loadDisabledModels() {
            try {
                const saved = localStorage.getItem('disabledModels');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    parsed.forEach(name => disabledModels.add(name));
                }
            } catch (error) {
                console.error('Error loading disabled models:', error);
            }
        }
        
        // Save disabled models to localStorage
        function saveDisabledModels() {
            try {
                localStorage.setItem('disabledModels', JSON.stringify([...disabledModels]));
            } catch (error) {
                console.error('Error saving disabled models:', error);
            }
        }
        
        // Toggle model enabled/disabled state
        function toggleModelState(modelName) {
            if (disabledModels.has(modelName)) {
                disabledModels.delete(modelName);
            } else {
                disabledModels.add(modelName);
            }
            saveDisabledModels();
            updateModelCardState(modelName);
        }
        
        // Update model card visual state
        function updateModelCardState(modelName) {
            const modelCard = document.querySelector(`[data-model-name="${modelName}"]`);
            if (!modelCard) return;
            
            const isDisabled = disabledModels.has(modelName);
            const contentDiv = modelCard.querySelector('.markdown-content');
            
            if (isDisabled) {
                modelCard.classList.add('model-disabled-container');
                contentDiv.classList.add('model-disabled');
            } else {
                modelCard.classList.remove('model-disabled-container');
                contentDiv.classList.remove('model-disabled');
            }
        }
        
        // Get list of enabled models only
        function getEnabledModels() {
            return allModels.filter(model => !disabledModels.has(model.name));
        }

        // Parameter validation cache
        const modelParameterLimits = new Map();

        // Parameter support mapping - defines which parameters each model supports
        function getModelSupportedParameters(modelName) {
            // Default support for most OpenAI-compatible models
            const defaultSupport = {
                temperature: true,
                top_p: true,
                max_tokens: true,
                seed: true,
                frequency_penalty: true,
                presence_penalty: true,
                repetition_penalty: false,
                top_k: false,
                min_p: false
            };

            // Model-specific overrides
            const modelSupport = {
                // OpenAI models support standard parameters
                'openai': defaultSupport,
                'openai-fast': defaultSupport,
                'openai-large': defaultSupport,
                'claude': defaultSupport,
                'claude-fast': defaultSupport,
                'claude-large': defaultSupport,
                
                // Gemini models - limited support
                'gemini': {
                    ...defaultSupport,
                    frequency_penalty: false,
                    presence_penalty: false,
                    seed: false
                },
                'gemini-fast': {
                    ...defaultSupport,
                    frequency_penalty: false,
                    presence_penalty: false,
                    seed: false
                },
                'gemini-large': {
                    ...defaultSupport,
                    frequency_penalty: false,
                    presence_penalty: false,
                    seed: false
                },
                
                // DeepSeek and open models often support top_k and repetition_penalty
                'deepseek': {
                    ...defaultSupport,
                    repetition_penalty: true,
                    top_k: true
                },
                'qwen-coder': {
                    ...defaultSupport,
                    repetition_penalty: true,
                    top_k: true
                },
                'mistral': {
                    ...defaultSupport,
                    top_k: true
                },
                
                // Perplexity models
                'perplexity-fast': defaultSupport,
                'perplexity-reasoning': defaultSupport,
                
                // Other models
                'grok': defaultSupport,
                'kimi': defaultSupport,
                'nova-fast': defaultSupport,
                'glm': {
                    ...defaultSupport,
                    repetition_penalty: true,
                    top_k: true
                }
            };

            return modelSupport[modelName] || defaultSupport;
        }

        // Parameter matrix generation
        function generateParameterMatrix(modelName) {
            // Get cached limits or use conservative defaults (most models support temp up to 1.0)
            const limits = modelParameterLimits.get(modelName) || {
                tempMin: 0.0, tempMax: 1.0, topPMin: 0.1, topPMax: 1.0
            };
            
            // If model only supports defaults, create a single-cell matrix
            if (limits.useDefaults) {
                return [{ 
                    temperature: 1.0, 
                    top_p: 1.0,
                    displayLabel: `Default Only`,
                    useDefaults: true
                }];
            }
            
            // Define focused parameter combinations for manageable matrix size
            const parameterCombinations = [
                // Core temperature/top-p variations (baseline)
                { temp: 0.0, topP: 1.0, presP: 0, freqP: 0, label: "T=0.0 P=1.0" },
                { temp: 0.3, topP: 0.7, presP: 0, freqP: 0, label: "T=0.3 P=0.7" },
                { temp: 0.5, topP: 1.0, presP: 0, freqP: 0, label: "T=0.5 P=1.0" },
                { temp: 0.7, topP: 0.4, presP: 0, freqP: 0, label: "T=0.7 P=0.4" },
                { temp: 1.0, topP: 1.0, presP: 0, freqP: 0, label: "T=1.0 P=1.0" },
                
                // Presence penalty variations
                { temp: 0.7, topP: 1.0, presP: -2, freqP: 0, label: "T=0.7 PP=-2" },
                { temp: 0.7, topP: 1.0, presP: -1, freqP: 0, label: "T=0.7 PP=-1" },
                { temp: 0.7, topP: 1.0, presP: 1, freqP: 0, label: "T=0.7 PP=+1" },
                { temp: 0.7, topP: 1.0, presP: 2, freqP: 0, label: "T=0.7 PP=+2" },
                
                // Frequency penalty variations  
                { temp: 0.7, topP: 1.0, presP: 0, freqP: -2, label: "T=0.7 FP=-2" },
                { temp: 0.7, topP: 1.0, presP: 0, freqP: -1, label: "T=0.7 FP=-1" },
                { temp: 0.7, topP: 1.0, presP: 0, freqP: 1, label: "T=0.7 FP=+1" },
                { temp: 0.7, topP: 1.0, presP: 0, freqP: 2, label: "T=0.7 FP=+2" },
                
                // Combined penalty effects
                { temp: 0.5, topP: 1.0, presP: 1, freqP: 1, label: "T=0.5 PP+FP=+1" },
                { temp: 0.5, topP: 1.0, presP: -1, freqP: -1, label: "T=0.5 PP+FP=-1" },
                { temp: 0.7, topP: 0.7, presP: 2, freqP: 1, label: "T=0.7 PP=+2 FP=+1" },
                { temp: 0.3, topP: 0.4, presP: -1, freqP: 1, label: "T=0.3 PP=-1 FP=+1" },
                
                // High creativity + penalties
                { temp: 1.0, topP: 0.7, presP: 1, freqP: 0, label: "T=1.0 P=0.7 PP=+1" },
                { temp: 1.0, topP: 1.0, presP: 0, freqP: 2, label: "T=1.0 FP=+2" },
                
                // Conservative + penalties
                { temp: 0.1, topP: 0.1, presP: 1, freqP: 1, label: "Conservative+Penalties" },
                { temp: 0.0, topP: 0.4, presP: 2, freqP: 0, label: "T=0 P=0.4 PP=+2" }
            ];
            
            // Filter combinations based on model limits and convert to expected format
            return parameterCombinations
                .filter(combo => combo.temp >= limits.tempMin && combo.temp <= limits.tempMax)
                .filter(combo => combo.topP >= limits.topPMin && combo.topP <= limits.topPMax)
                .map(combo => ({
                    temperature: combo.temp,
                    top_p: combo.topP, 
                    presence_penalty: combo.presP,
                    frequency_penalty: combo.freqP,
                    displayLabel: combo.label
                }));
        }

        // Mode switching functions
        function enterMatrixMode(modelName) {
            currentMode = 'matrix';
            selectedModel = modelName;
            document.body.classList.add('matrix-mode');
            updateHeaderForMatrixMode();
            
            // Hide multi-model view and show matrix view
            document.getElementById('multi-model-view').classList.add('hidden');
            document.getElementById('matrix-view').classList.remove('hidden');
            
            renderMatrixView();
        }

        function exitMatrixMode() {
            currentMode = 'multi';
            selectedModel = null;
            document.body.classList.remove('matrix-mode');
            updateHeaderForMultiMode();
            
            // Hide matrix view and show multi-model view (preserving content)
            document.getElementById('matrix-view').classList.add('hidden');
            document.getElementById('multi-model-view').classList.remove('hidden');
        }

        function updateHeaderForMatrixMode() {
            const titleElement = document.querySelector('h1');
            const limits = modelParameterLimits.get(selectedModel);
            const subtitle = limits?.useDefaults 
                ? 'Default Parameters Only' 
                : 'Parameter Matrix: Temperature, Top-P, Presence & Frequency Penalties';
            
            titleElement.innerHTML = `
                <span class="cursor-pointer" onclick="exitMatrixMode()">[‚Üê Back to Multi-Model]</span>
                <br>
                <span class="text-lg">${selectedModel}</span> Parameter Matrix
                <span class="block text-sm text-gray-500 dark:text-gray-400 font-normal">${subtitle}</span>
            `;
        }

        function updateHeaderForMultiMode() {
            const titleElement = document.querySelector('h1');
            titleElement.innerHTML = `
                Pollinations.ai Model Comparison 
                <a href="https://github.com/EndemicMedia/FLARE" class="block md:inline text-sm text-orange-400 dark:text-orange-400">
                    by EndemicMedia
                </a>
            `;
        }

        // Prompt history management
        function savePrompt(prompt) {
            if (!prompt) return;

            try {
                // Retrieve existing prompts
                let promptHistory = JSON.parse(localStorage.getItem('promptHistory') || '[]');
                
                // Remove duplicates and add new prompt to the beginning
                promptHistory = promptHistory.filter(p => p !== prompt);
                promptHistory.unshift(prompt);

                // Limit history size
                promptHistory = promptHistory.slice(0, MAX_PROMPT_HISTORY);

                // Save back to localStorage
                localStorage.setItem('promptHistory', JSON.stringify(promptHistory));
            } catch (error) {
                console.error('Error saving prompt to localStorage:', error);
            }
        }

        function loadPromptHistory() {
            try {
                const promptHistory = JSON.parse(localStorage.getItem('promptHistory') || '[]');
                const datalist = document.getElementById('prompt-history');
                const dropdown = document.getElementById('prompt-dropdown');
                
                if (!datalist) {
                    console.error('Could not find prompt-history datalist element');
                    return;
                }
                
                // Clear existing options
                datalist.innerHTML = '';
                if (dropdown) dropdown.innerHTML = '';

                // Populate datalist with prompt history
                promptHistory.forEach((prompt, index) => {
                    const option = document.createElement('option');
                    option.value = prompt;
                    datalist.appendChild(option);
                    
                    // Also populate custom dropdown
                    if (dropdown) {
                        const dropdownItem = document.createElement('div');
                        dropdownItem.className = 'px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer border-b border-gray-200 dark:border-gray-600 last:border-b-0 text-gray-900 dark:text-white';
                        dropdownItem.textContent = prompt;
                        dropdownItem.addEventListener('click', () => {
                            document.getElementById('prompt-input').value = prompt;
                            hidePromptDropdown();
                        });
                        dropdown.appendChild(dropdownItem);
                    }
                });
            } catch (error) {
                console.error('Error loading prompt history:', error);
            }
        }

        function showPromptDropdown() {
            const dropdown = document.getElementById('prompt-dropdown');
            const promptHistory = JSON.parse(localStorage.getItem('promptHistory') || '[]');
            
            console.log('showPromptDropdown called');
            console.log('Dropdown element:', dropdown);
            console.log('Prompt history length:', promptHistory.length);
            console.log('Dropdown children count:', dropdown ? dropdown.children.length : 'N/A');
            
            if (dropdown && promptHistory.length > 0) {
                dropdown.classList.remove('hidden');
                console.log('‚úÖ Showing custom dropdown with', promptHistory.length, 'items');
                console.log('Dropdown classes:', dropdown.className);
                
                // Check if dropdown is actually visible
                const rect = dropdown.getBoundingClientRect();
                const computedStyle = window.getComputedStyle(dropdown);
                console.log('üìç Dropdown position:', {
                    top: rect.top,
                    left: rect.left,
                    width: rect.width,
                    height: rect.height,
                    display: computedStyle.display,
                    visibility: computedStyle.visibility,
                    opacity: computedStyle.opacity
                });
            } else {
                console.log('‚ùå Cannot show dropdown - missing element or no history');
            }
        }

        function hidePromptDropdown() {
            const dropdown = document.getElementById('prompt-dropdown');
            if (dropdown && !dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
                console.log('üîΩ Hiding custom dropdown');
            }
        }

        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;

        // Initialize theme on page load and detect system dark mode
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                // Use saved theme preference
                htmlElement.classList.toggle('dark', savedTheme === 'dark');
            } else {
                // Detect system dark mode
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                htmlElement.classList.toggle('dark', systemPrefersDark);
                localStorage.setItem('theme', systemPrefersDark ? 'dark' : 'light');
            }
        }

        themeToggle.addEventListener('click', () => {
            // Toggle dark mode
            const isDarkMode = htmlElement.classList.toggle('dark');
            
            // Save theme preference
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });

        // Initialize theme when page loads
        initTheme();

        // Parameters toggle functionality
        const parametersToggleBtn = document.getElementById('parameters-toggle-btn');
        const parametersCollapseBtn = document.getElementById('parameters-collapse-btn');
        const parametersExpanded = document.getElementById('parameters-expanded');

        function toggleParameters() {
            const isExpanded = !parametersExpanded.classList.contains('hidden');
            
            if (isExpanded) {
                // Collapse
                parametersExpanded.classList.add('hidden');
                localStorage.setItem('parametersExpanded', 'false');
            } else {
                // Expand
                parametersExpanded.classList.remove('hidden');
                localStorage.setItem('parametersExpanded', 'true');
            }
        }

        parametersToggleBtn.addEventListener('click', toggleParameters);
        parametersCollapseBtn.addEventListener('click', toggleParameters);

        // Initialize parameters state from localStorage
        function initParametersState() {
            const savedState = localStorage.getItem('parametersExpanded');
            if (savedState === 'true') {
                parametersExpanded.classList.remove('hidden');
            }
        }

        initParametersState();

        // Model parameter controls
        const temperatureSlider = document.getElementById('temperature-slider');
        const temperatureValue = document.getElementById('temperature-value');
        const topPSlider = document.getElementById('top-p-slider');
        const topPValue = document.getElementById('top-p-value');
        const maxTokensSlider = document.getElementById('max-tokens-slider');
        const maxTokensValue = document.getElementById('max-tokens-value');
        const seedSlider = document.getElementById('seed-slider');
        const seedValue = document.getElementById('seed-value');
        const frequencyPenaltySlider = document.getElementById('frequency-penalty-slider');
        const frequencyPenaltyValue = document.getElementById('frequency-penalty-value');
        const presencePenaltySlider = document.getElementById('presence-penalty-slider');
        const presencePenaltyValue = document.getElementById('presence-penalty-value');
        const repetitionPenaltySlider = document.getElementById('repetition-penalty-slider');
        const repetitionPenaltyValue = document.getElementById('repetition-penalty-value');
        const topKSlider = document.getElementById('top-k-slider');
        const topKValue = document.getElementById('top-k-value');
        const minPSlider = document.getElementById('min-p-slider');
        const minPValue = document.getElementById('min-p-value');

        // Update temperature display
        temperatureSlider.addEventListener('input', () => {
            temperatureValue.textContent = parseFloat(temperatureSlider.value).toFixed(1);
            localStorage.setItem('modelTemperature', temperatureSlider.value);
        });

        // Update top-p display
        topPSlider.addEventListener('input', () => {
            topPValue.textContent = parseFloat(topPSlider.value).toFixed(2);
            localStorage.setItem('modelTopP', topPSlider.value);
        });

        // Update max tokens display
        maxTokensSlider.addEventListener('input', () => {
            maxTokensValue.textContent = maxTokensSlider.value;
            localStorage.setItem('modelMaxTokens', maxTokensSlider.value);
        });

        // Update seed display
        seedSlider.addEventListener('input', () => {
            const seedVal = parseInt(seedSlider.value);
            seedValue.textContent = seedVal === 0 ? 'rand' : seedVal;
            localStorage.setItem('modelSeed', seedSlider.value);
        });

        // Update frequency penalty display
        frequencyPenaltySlider.addEventListener('input', () => {
            frequencyPenaltyValue.textContent = parseFloat(frequencyPenaltySlider.value).toFixed(1);
            localStorage.setItem('modelFrequencyPenalty', frequencyPenaltySlider.value);
        });

        // Update presence penalty display
        presencePenaltySlider.addEventListener('input', () => {
            presencePenaltyValue.textContent = parseFloat(presencePenaltySlider.value).toFixed(1);
            localStorage.setItem('modelPresencePenalty', presencePenaltySlider.value);
        });

        // Update repetition penalty display
        repetitionPenaltySlider.addEventListener('input', () => {
            repetitionPenaltyValue.textContent = parseFloat(repetitionPenaltySlider.value).toFixed(1);
            localStorage.setItem('modelRepetitionPenalty', repetitionPenaltySlider.value);
        });

        // Update top-k display
        topKSlider.addEventListener('input', () => {
            const topKVal = parseInt(topKSlider.value);
            topKValue.textContent = topKVal === 0 ? 'off' : topKVal;
            localStorage.setItem('modelTopK', topKSlider.value);
        });

        // Update min-p display
        minPSlider.addEventListener('input', () => {
            minPValue.textContent = parseFloat(minPSlider.value).toFixed(2);
            localStorage.setItem('modelMinP', minPSlider.value);
        });

        // Load saved parameter values
        function loadSavedParameters() {
            const savedTemp = localStorage.getItem('modelTemperature');
            const savedTopP = localStorage.getItem('modelTopP');
            const savedMaxTokens = localStorage.getItem('modelMaxTokens');
            const savedSeed = localStorage.getItem('modelSeed');
            const savedFreqPenalty = localStorage.getItem('modelFrequencyPenalty');
            const savedPresPenalty = localStorage.getItem('modelPresencePenalty');
            const savedRepPenalty = localStorage.getItem('modelRepetitionPenalty');
            const savedTopK = localStorage.getItem('modelTopK');
            const savedMinP = localStorage.getItem('modelMinP');

            if (savedTemp) {
                temperatureSlider.value = savedTemp;
                temperatureValue.textContent = parseFloat(savedTemp).toFixed(1);
            }
            if (savedTopP) {
                topPSlider.value = savedTopP;
                topPValue.textContent = parseFloat(savedTopP).toFixed(2);
            }
            if (savedMaxTokens) {
                maxTokensSlider.value = savedMaxTokens;
                maxTokensValue.textContent = savedMaxTokens;
            }
            if (savedSeed) {
                seedSlider.value = savedSeed;
                const seedVal = parseInt(savedSeed);
                seedValue.textContent = seedVal === 0 ? 'rand' : seedVal;
            }
            if (savedFreqPenalty) {
                frequencyPenaltySlider.value = savedFreqPenalty;
                frequencyPenaltyValue.textContent = parseFloat(savedFreqPenalty).toFixed(1);
            }
            if (savedPresPenalty) {
                presencePenaltySlider.value = savedPresPenalty;
                presencePenaltyValue.textContent = parseFloat(savedPresPenalty).toFixed(1);
            }
            if (savedRepPenalty) {
                repetitionPenaltySlider.value = savedRepPenalty;
                repetitionPenaltyValue.textContent = parseFloat(savedRepPenalty).toFixed(1);
            }
            if (savedTopK) {
                topKSlider.value = savedTopK;
                const topKVal = parseInt(savedTopK);
                topKValue.textContent = topKVal === 0 ? 'off' : topKVal;
            }
            if (savedMinP) {
                minPSlider.value = savedMinP;
                minPValue.textContent = parseFloat(savedMinP).toFixed(2);
            }
        }

        // Load saved parameters on page load
        loadSavedParameters();

        // Reset parameters to defaults
        const parametersResetBtn = document.getElementById('parameters-reset-btn');
        
        function resetParametersToDefaults() {
            // Default values
            const defaults = {
                temperature: 0.7,
                topP: 1.0,
                maxTokens: 500,
                seed: 0,
                frequencyPenalty: 0,
                presencePenalty: 0,
                repetitionPenalty: 0,
                topK: 0,
                minP: 0
            };
            
            // Update sliders
            temperatureSlider.value = defaults.temperature;
            temperatureValue.textContent = defaults.temperature.toFixed(1);
            
            topPSlider.value = defaults.topP;
            topPValue.textContent = defaults.topP.toFixed(2);
            
            maxTokensSlider.value = defaults.maxTokens;
            maxTokensValue.textContent = defaults.maxTokens;
            
            seedSlider.value = defaults.seed;
            seedValue.textContent = 'rand';
            
            frequencyPenaltySlider.value = defaults.frequencyPenalty;
            frequencyPenaltyValue.textContent = defaults.frequencyPenalty.toFixed(1);
            
            presencePenaltySlider.value = defaults.presencePenalty;
            presencePenaltyValue.textContent = defaults.presencePenalty.toFixed(1);
            
            repetitionPenaltySlider.value = defaults.repetitionPenalty;
            repetitionPenaltyValue.textContent = defaults.repetitionPenalty.toFixed(1);
            
            topKSlider.value = defaults.topK;
            topKValue.textContent = 'off';
            
            minPSlider.value = defaults.minP;
            minPValue.textContent = defaults.minP.toFixed(2);
            
            // Update localStorage
            localStorage.setItem('modelTemperature', defaults.temperature);
            localStorage.setItem('modelTopP', defaults.topP);
            localStorage.setItem('modelMaxTokens', defaults.maxTokens);
            localStorage.setItem('modelSeed', defaults.seed);
            localStorage.setItem('modelFrequencyPenalty', defaults.frequencyPenalty);
            localStorage.setItem('modelPresencePenalty', defaults.presencePenalty);
            localStorage.setItem('modelRepetitionPenalty', defaults.repetitionPenalty);
            localStorage.setItem('modelTopK', defaults.topK);
            localStorage.setItem('modelMinP', defaults.minP);
        }
        
        parametersResetBtn.addEventListener('click', resetParametersToDefaults);

        // Font size controls
        const fontDecreaseBtn = document.getElementById('font-decrease-btn');
        const fontIncreaseBtn = document.getElementById('font-increase-btn');
        
        // Tailwind text size classes from smallest to largest
        const fontSizes = ['text-xs', 'text-sm', 'text-base', 'text-lg', 'text-xl', 'text-2xl', 'text-3xl'];
        let currentFontSizeIndex = 2; // Default to 'text-base'

        function updateModelResponseFontSize() {
            const modelResponses = document.querySelectorAll('.markdown-content:not(#fullscreen-content)');
            modelResponses.forEach(response => {
                // Remove all font size classes
                fontSizes.forEach(size => response.classList.remove(size));
                // Add current font size class
                response.classList.add(fontSizes[currentFontSizeIndex]);
            });
        }

        fontDecreaseBtn.addEventListener('click', () => {
            if (currentFontSizeIndex > 0) {
                currentFontSizeIndex--;
                updateModelResponseFontSize();
            }
        });

        fontIncreaseBtn.addEventListener('click', () => {
            if (currentFontSizeIndex < fontSizes.length - 1) {
                currentFontSizeIndex++;
                updateModelResponseFontSize();
            }
        });

        // System context selection
        const systemContextSelect = document.getElementById('system-context');

        // Load saved system context preference
        const savedSystemContext = localStorage.getItem('systemContext') || 'concise';
        systemContextSelect.value = savedSystemContext;

        // Save system context preference when changed
        systemContextSelect.addEventListener('change', () => {
            localStorage.setItem('systemContext', systemContextSelect.value);
        });

        async function fetchModels() {
            console.log('Fetching models...');
            try {
                const apiKey = getApiKey();
                const response = await axios.get(
                    'https://gen.pollinations.ai/text/models',
                    { 
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    }
                );
                console.log('Models API response:', response);
                
                // /text/models returns array directly with full model details including pricing
                let models = [];
                if (Array.isArray(response.data)) {
                    models = response.data;
                    console.log('Fetched models count:', models.length);
                } else {
                    console.warn('Models API returned unexpected data:', response.data);
                }
                
                models.forEach((model, idx) => {
                    console.log(`Model[${idx}]:`, model);
                });
                
                return models;
            } catch (error) {
                console.error('Error fetching models:', error);
                return [];
            }
        }

        function calculateTextStatistics(text) {
            const cleanText = text.trim();
            return {
                characters: cleanText.length,
                words: cleanText.split(/\s+/).filter(word => word.length > 0).length,
                sentences: cleanText.split(/[.!?]+/).filter(sentence => sentence.trim().length > 0).length
            };
        }

        function calculatePollenCost(usage, pricing) {
            if (!usage || !pricing || !pricing.promptTextTokens) return null;
            
            const promptTokens = usage.prompt_tokens || 0;
            const cachedTokens = usage.prompt_tokens_details?.cached_tokens || 0;
            const completionTokens = usage.completion_tokens || 0;
            
            const uncachedPromptTokens = promptTokens - cachedTokens;
            
            let cost = 0;
            
            // Calculate uncached prompt token cost
            cost += uncachedPromptTokens * pricing.promptTextTokens;
            
            // Calculate cached prompt token cost if available
            if (pricing.promptCachedTokens && cachedTokens > 0) {
                cost += cachedTokens * pricing.promptCachedTokens;
            }
            
            // Calculate completion token cost
            if (pricing.completionTextTokens) {
                cost += completionTokens * pricing.completionTextTokens;
            }
            
            return cost;
        }

        function formatPollenCost(cost) {
            if (cost === null || cost === undefined) return '';
            if (cost === 0) return '0 üå∏';
            
            // For very small numbers, use exponential notation or many decimals
            if (cost < 0.0000000001) return cost.toExponential(2) + ' üå∏';
            if (cost < 0.000001) return cost.toFixed(10) + ' üå∏';
            if (cost < 0.001) return cost.toFixed(8) + ' üå∏';
            if (cost < 1) return cost.toFixed(6) + ' üå∏';
            return cost.toFixed(4) + ' üå∏';
        }

        function getModelInfoTooltip(model) {
            const capabilities = [];
            
            // Input modalities
            if (model.input_modalities?.includes('image')) capabilities.push('üëÅÔ∏è Vision');
            if (model.input_modalities?.includes('audio')) capabilities.push('üéôÔ∏è Audio In');
            
            // Output modalities  
            if (model.output_modalities?.includes('audio')) capabilities.push('üîä Audio Out');
            
            // Features
            if (model.tools) capabilities.push('üîß Tools');
            if (model.reasoning) capabilities.push('üß† Reasoning');
            
            // Context window
            const contextWindow = model.context_window ? `${(model.context_window / 1000).toFixed(0)}K tokens` : 'Unknown';
            
            // Pricing
            const pricing = model.pricing || {};
            const promptCost = pricing.promptTextTokens ? (pricing.promptTextTokens * 1000000).toFixed(2) : 'N/A';
            const completionCost = pricing.completionTextTokens ? (pricing.completionTextTokens * 1000000).toFixed(2) : 'N/A';
            
            let tooltip = `<div class="font-semibold mb-1">${model.name}</div>`;
            
            if (model.description) {
                tooltip += `<div class="text-xs mb-2">${model.description}</div>`;
            }
            
            if (capabilities.length > 0) {
                tooltip += `<div class="text-xs mb-1">${capabilities.join(' ‚Ä¢ ')}</div>`;
            }
            
            tooltip += `<div class="text-xs">üìè Context: ${contextWindow}</div>`;
            tooltip += `<div class="text-xs">üí∞ Input: ${promptCost}/M ‚Ä¢ Output: ${completionCost}/M</div>`;
            
            if (model.paid_only) {
                tooltip += `<div class="text-xs text-purple-400 mt-1">üíé Paid Only</div>`;
            }
            
            return tooltip;
        }

        function getSystemPrompt(context) { return SYSTEM_PROMPTS[context] }

        // Model tooltip functions
        let modelDataCache = new Map();
        
        function showModelTooltip(event, modelId) {
            const model = modelDataCache.get(modelId);
            if (!model) return;
            
            const tooltip = document.getElementById('model-tooltip');
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            
            tooltip.innerHTML = getModelInfoTooltip(model);
            tooltip.style.left = (rect.right + 8) + 'px';
            tooltip.style.top = rect.top + 'px';
            tooltip.classList.remove('hidden');
        }

        function hideModelTooltip() {
            const tooltip = document.getElementById('model-tooltip');
            tooltip.classList.add('hidden');
        }

        // Matrix view rendering
        function renderMatrixView() {
            const matrixContainer = document.getElementById('matrix-view');
            const combinations = generateParameterMatrix(selectedModel);
            
            // Adaptive grid based on combinations count  
            let gridCols = 'grid-cols-5'; // default for ~20 combinations
            if (combinations.length === 1) gridCols = 'grid-cols-1'; // single default-only model
            else if (combinations.length <= 6) gridCols = 'grid-cols-3'; // smaller matrices
            else if (combinations.length <= 12) gridCols = 'grid-cols-4'; // medium matrices
            else if (combinations.length <= 20) gridCols = 'grid-cols-5'; // 20-combination focused matrix
            
            matrixContainer.className = `grid ${gridCols} gap-4`;
            matrixContainer.innerHTML = '';
            combinations.forEach((combo, idx) => {
                const matrixDiv = document.createElement('div');
                matrixDiv.classList.add('matrix-card', 'border', 'rounded-lg', 'p-3', 'bg-white', 'dark:bg-gray-800', 'shadow-sm');
                matrixDiv.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <div class="flex items-start space-x-2">
                            <div class="parameter-label">${combo.displayLabel}</div>
                        </div>
                        <div class="flex items-start">
                            <div id="matrix-stats-${idx}" class="text-xs text-gray-500 dark:text-gray-400"></div>
                            <div class="grid ml-2">
                                <button
                                    class="fullscreen-btn hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                    data-matrix-index="${idx}"
                                    title="View fullscreen"
                                    >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                    </svg>
                                </button>
                                <button
                                    class="copy-btn hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                    data-matrix-index="${idx}"
                                    title="Copy output"
                                    >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div
                        id="matrix-${idx}"
                        class="markdown-content w-full py-1 h-48 overflow-y-auto text-base dark:text-white"
                        placeholder="Response will appear here..."
                    ></div>
                `;
                matrixContainer.appendChild(matrixDiv);
            });
        }


        async function queryModel(model, prompt, retryCount = 0, abortSignal = null, parameterOverride = null) {
            const MAX_RETRIES = 3;
            const RETRY_DELAY = 1000; // 1 second initial delay
            
            try {
                const systemContextSelect = document.getElementById('system-context');
                if (!systemContextSelect) {
                    throw new Error('System context select not found');
                }
                const systemContext = systemContextSelect.value;

                const startTime = performance.now();
                const timeoutDropdown = document.getElementById('timeout-dropdown');
                if (!timeoutDropdown) {
                    throw new Error('Timeout dropdown not found');
                }
                const timeoutValue = parseInt(timeoutDropdown.value, 10);

                // Get model parameters from UI controls or override
                let temperature, topP, maxTokens, seed, presencePenalty, frequencyPenalty, repetitionPenalty, topK, minP;
                
                // For models that only support defaults, don't override parameters
                if (parameterOverride?.useDefaults) {
                    temperature = parseFloat(temperatureSlider.value);
                    topP = parseFloat(topPSlider.value);
                    maxTokens = parseInt(maxTokensSlider.value);
                    const seedVal = parseInt(seedSlider.value);
                    seed = seedVal === 0 ? undefined : seedVal;
                    presencePenalty = parseFloat(presencePenaltySlider.value);
                    frequencyPenalty = parseFloat(frequencyPenaltySlider.value);
                    repetitionPenalty = parseFloat(repetitionPenaltySlider.value);
                    const topKVal = parseInt(topKSlider.value);
                    topK = topKVal === 0 ? undefined : topKVal;
                    minP = parseFloat(minPSlider.value);
                } else {
                    temperature = parameterOverride?.temperature ?? parseFloat(temperatureSlider.value);
                    topP = parameterOverride?.top_p ?? parseFloat(topPSlider.value);
                    maxTokens = parameterOverride?.max_tokens ?? parseInt(maxTokensSlider.value);
                    const seedVal = parameterOverride?.seed ?? parseInt(seedSlider.value);
                    seed = seedVal === 0 ? undefined : seedVal;
                    presencePenalty = parameterOverride?.presence_penalty ?? parseFloat(presencePenaltySlider.value);
                    frequencyPenalty = parameterOverride?.frequency_penalty ?? parseFloat(frequencyPenaltySlider.value);
                    repetitionPenalty = parameterOverride?.repetition_penalty ?? parseFloat(repetitionPenaltySlider.value);
                    const topKVal = parameterOverride?.top_k ?? parseInt(topKSlider.value);
                    topK = topKVal === 0 ? undefined : topKVal;
                    minP = parameterOverride?.min_p ?? parseFloat(minPSlider.value);
                }

                // Prepare the request body with model parameters
                const requestBody = {
                    model: model.name,
                    messages: [
                        {
                            role: 'system',
                            content: getSystemPrompt(systemContext)
                        },
                        { role: 'user', content: prompt }
                    ]
                };

                // Check if this model has parameter restrictions
                const limits = modelParameterLimits.get(model.name);
                
                // Get supported parameters for this model
                const supportedParams = getModelSupportedParameters(model.name);
                
                // Only add parameters if model supports them
                if (!limits?.useDefaults) {
                    if (supportedParams.temperature) requestBody.temperature = temperature;
                    if (supportedParams.top_p) requestBody.top_p = topP;
                    if (supportedParams.max_tokens) requestBody.max_tokens = maxTokens;
                    
                    // Add penalty parameters if supported and non-default
                    if (supportedParams.presence_penalty && presencePenalty !== 0) {
                        requestBody.presence_penalty = presencePenalty;
                    }
                    if (supportedParams.frequency_penalty && frequencyPenalty !== 0) {
                        requestBody.frequency_penalty = frequencyPenalty;
                    }
                    if (supportedParams.repetition_penalty && repetitionPenalty !== 0) {
                        requestBody.repetition_penalty = repetitionPenalty;
                    }
                    
                    // Add sampling parameters if supported and specified
                    if (supportedParams.seed && seed !== undefined) {
                        requestBody.seed = seed;
                    }
                    if (supportedParams.top_k && topK !== undefined) {
                        requestBody.top_k = topK;
                    }
                    if (supportedParams.min_p && minP !== 0) {
                        requestBody.min_p = minP;
                    }
                } else {
                    console.log(`${model.name}: Using default parameters only (no temp/top_p sent)`);
                }

                // Send request
                const apiKey = getApiKey();
                
                const response = await axios.post(CHAT_URL, requestBody, {
                    timeout: timeoutValue, // Use selected timeout value
                    signal: abortSignal, // Add abort signal support
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                // Validate response structure
                if (!response.data) {
                    throw new Error('No response data received');
                }
                
                if (!response.data.choices || !Array.isArray(response.data.choices) || response.data.choices.length === 0) {
                    console.error('Invalid response structure:', response.data);
                    throw new Error('Invalid response: missing choices array');
                }
                
                if (!response.data.choices[0].message || !response.data.choices[0].message.content) {
                    console.error('Invalid message structure:', response.data.choices[0]);
                    throw new Error('Invalid response: missing message content');
                }
                
                return {
                    text: response.data.choices[0].message.content,
                    duration: duration,
                    usage: response.data.usage || {},
                    pricing: model.pricing || {}
                };
            } catch (error) {
                // Check if the error is due to cancellation
                if (axios.isCancel(error)) {
                    console.log('Request cancelled:', error.message);
                    return { text: 'Request cancelled', duration: 0 };
                }

                console.error(`Error with ${model.name}:`, error);
                
                // Handle parameter validation errors
                if (error.response && error.response.data && error.response.data.details) {
                    const errorMessage = error.response.data.details.error?.message || '';
                    if (errorMessage.includes('temperature') || errorMessage.includes('top_p')) {
                        console.log(`Parameter limits detected for ${model.name}:`, errorMessage);
                        
                        // Check if model only supports default values
                        if (errorMessage.includes('Only the default') || errorMessage.includes('only support')) {
                            // Model only supports defaults - cache immediately and retry without parameters
                            modelParameterLimits.set(model.name, {
                                tempMin: 1.0, tempMax: 1.0, topPMin: 1.0, topPMax: 1.0,
                                useDefaults: true
                            });
                            
                            // Retry immediately without parameters if we have retries left
                            if (retryCount < MAX_RETRIES && !abortSignal?.aborted) {
                                console.log(`Retrying ${model.name} without parameters - Attempt ${retryCount + 1}`);
                                return queryModel(model, prompt, retryCount + 1, abortSignal, parameterOverride);
                            }
                        } else {
                            // Cache more conservative limits
                            modelParameterLimits.set(model.name, {
                                tempMin: 0.0, tempMax: 1.0, topPMin: 0.1, topPMax: 1.0
                            });
                        }
                    }
                }
                
                if (retryCount < MAX_RETRIES && !abortSignal?.aborted) {
                    // Exponential backoff
                    const delay = RETRY_DELAY * Math.pow(2, retryCount);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    
                    console.log(`Retrying ${model.name} - Attempt ${retryCount + 1}`);
                    return queryModel(model, prompt, retryCount + 1, abortSignal, parameterOverride);
                }
                
                return {
                    text: `Error after ${MAX_RETRIES} attempts: ${error.message}`,
                    duration: Infinity
                };
            }
        }

        async function initializeModelFields() {
            const modelsContainer = document.getElementById('multi-model-view');
            if (!modelsContainer) {
                console.error('Could not find #multi-model-view in DOM');
                return [];
            }
            const models = await fetchModels();
            console.log('initializeModelFields: models received:', models);

            if (!models || !Array.isArray(models) || models.length === 0) {
                console.warn('No models found or models is not an array:', models);
                modelsContainer.innerHTML = '<div class="col-span-full text-center text-red-500">No models found. Please check the models API response in the console.</div>';
                return [];
            }

            models.forEach((model, idx) => {
                if (!model || !model.name) {
                    console.warn(`Model at index ${idx} is missing or has no "name":`, model);
                    return;
                }
                console.log(`Rendering model card for: ${model.name}`);
                
                // Cache model data for tooltip
                modelDataCache.set(model.name, model);
                
                const modelDiv = document.createElement('div');
                modelDiv.classList.add('border', 'rounded-lg', 'p-3', 'bg-white', 'dark:bg-gray-800', 'shadow-sm', 'model-card', 'relative', 'overflow-visible');
                modelDiv.setAttribute('data-model-name', model.name);
                modelDiv.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <div class="flex items-start space-x-2">
                            <label class="text-gray-700 dark:text-gray-300 font-semibold text-sm cursor-pointer" onclick="event.stopPropagation(); enterMatrixMode('${model.name}')">${model.name}</label>
                            <button 
                                class="model-info-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 relative group"
                                onclick="event.stopPropagation()"
                                onmouseenter="showModelTooltip(event, '${model.name}')"
                                onmouseleave="hideModelTooltip()"
                                title="Model details"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-start">
                            <div id="model-stats-${model.name}" class="text-xs text-gray-500 dark:text-gray-400"></div>
                            <div class="grid ml-2">
                                <button
                                    class="fullscreen-btn hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                    data-model="${model.name}"
                                    title="View fullscreen"
                                    onclick="event.stopPropagation()"
                                    >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                    </svg>
                                </button>
                                <button
                                    class="copy-btn hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                                    data-model="${model.name}"
                                    title="Copy model output"
                                    onclick="event.stopPropagation()"
                                    >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div
                        id="model-${model.name}"
                        class="markdown-content w-full py-1 h-48 overflow-y-auto text-base dark:text-white"
                        placeholder="Model response will appear here..."
                    ></div>
                `;
                
                // Add click handler to toggle model state
                modelDiv.addEventListener('click', (e) => {
                    // Don't toggle if clicking on buttons or labels
                    if (e.target.closest('button') || e.target.closest('label')) {
                        return;
                    }
                    toggleModelState(model.name);
                });
                
                modelsContainer.appendChild(modelDiv);
                
                // Apply saved disabled state
                updateModelCardState(model.name);
            });

            console.log('Model cards rendered. modelsContainer child count:', modelsContainer.childElementCount);

            // Store models globally for matrix mode
            allModels = models;
            return models;
        }

document.addEventListener('DOMContentLoaded', async () => {
    // Dynamically load system prompts and populate dropdown
    async function loadSystemPrompts() {
        // Method 1: Standard fetch
        try {
            console.log('Attempting to load system prompts via fetch...');
            const response = await fetch('./system.json');
            if (!response.ok) {
                throw new Error('Failed to load system prompts via fetch');
            }
            return await response.json();
        } catch (fetchError) {
            console.warn('Fetch method failed:', fetchError);

            // Method 2: XMLHttpRequest for local file loading
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', './system.json', true);
                xhr.responseType = 'json';
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        console.log('Successfully loaded system prompts via XMLHttpRequest');
                        resolve(xhr.response);
                    } else {
                        reject(new Error('XMLHttpRequest failed'));
                    }
                };
                xhr.onerror = () => reject(new Error('XMLHttpRequest error'));
                xhr.send();
            });
        }
    }

    console.log('Loading system prompts...');
    try {
        const systemPromptsData = await loadSystemPrompts();
        SYSTEM_PROMPTS = systemPromptsData.systemPrompts;
        const systemContextSelect = document.getElementById('system-context');
        
        // Clear existing options
        systemContextSelect.innerHTML = '';
        
        // Populate dropdown with keys from systemPrompts
        Object.keys(SYSTEM_PROMPTS).forEach(context => {
            const option = document.createElement('option');
            option.value = context;
            option.textContent = context.charAt(0).toUpperCase() + context.slice(1);
            systemContextSelect.appendChild(option);
        });

        // Set default value to saved or first option
        const savedSystemContext = localStorage.getItem('systemContext') || Object.keys(SYSTEM_PROMPTS)[0];
        systemContextSelect.value = savedSystemContext;
    } catch (error) {
        console.error('Error loading system prompts:', error);
        alert('Could not load system prompts. Some functionality may be limited.');
    }

    console.log('System prompts loaded');

    // Load disabled models from localStorage
    loadDisabledModels();

    const models = await initializeModelFields();
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const promptInput = document.getElementById('prompt-input');
    const modelsContainer = document.getElementById('models-container');
    const fullscreenModal = document.getElementById('fullscreen-modal');
    const fullscreenContent = document.getElementById('fullscreen-content');
    const closeFullscreenBtn = document.getElementById('close-fullscreen-btn');

    // Trigger native datalist to show all options on click/focus
    function triggerDatalistDropdown(inputElement) {
        console.log('Attempting to trigger datalist dropdown');
        
        // Method: Clear value temporarily to show all options, then restore
        const originalValue = inputElement.value;
        
        // Clear the input to show all datalist options
        inputElement.value = '';
        
        // Trigger input event to refresh datalist
        const inputEvent = new Event('input', { bubbles: true });
        inputElement.dispatchEvent(inputEvent);
        
        // Focus the input to ensure datalist appears
        inputElement.focus();
        
        // Restore original value after a short delay
        setTimeout(() => {
            inputElement.value = originalValue;
        }, 100);
    }

    // Show datalist dropdown on focus
    promptInput.addEventListener('focus', () => {
        const datalist = document.getElementById('prompt-history');
        
        // Try native trigger first, then fallback to custom dropdown
        if (datalist && datalist.children.length > 0) {
            setTimeout(() => {
                triggerDatalistDropdown(promptInput);
            }, 50);
            
            // Also show custom dropdown as reliable fallback
            showPromptDropdown();
        }
    });

    // Show datalist dropdown on click  
    promptInput.addEventListener('click', () => {
        const datalist = document.getElementById('prompt-history');
        
        if (datalist && datalist.children.length > 0) {
            triggerDatalistDropdown(promptInput);
            // Also show custom dropdown as reliable fallback
            showPromptDropdown();
        }
    });

    promptInput.addEventListener('input', (e) => {
        
        // Filter custom dropdown based on input
        const value = e.target.value.toLowerCase();
        const dropdown = document.getElementById('prompt-dropdown');
        if (dropdown && !dropdown.classList.contains('hidden')) {
            const items = dropdown.children;
            let visibleCount = 0;
            Array.from(items).forEach(item => {
                if (item.textContent.toLowerCase().includes(value) || value === '') {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            if (visibleCount === 0 && value !== '') {
                hidePromptDropdown();
            }
        }
    });

    let dropdownHideTimeout;
    let isDropdownInteraction = false;
    
    // Prevent dropdown hide when interacting with dropdown
    const dropdown = document.getElementById('prompt-dropdown');
    if (dropdown) {
        dropdown.addEventListener('mouseenter', () => {
            isDropdownInteraction = true;
            console.log('Mouse entered dropdown, preventing hide');
            if (dropdownHideTimeout) {
                clearTimeout(dropdownHideTimeout);
            }
        });
        
        dropdown.addEventListener('mouseleave', () => {
            isDropdownInteraction = false;
            console.log('Mouse left dropdown, allowing hide');
        });
    }
    
    promptInput.addEventListener('blur', (e) => {
        console.log('Input blurred, isDropdownInteraction:', isDropdownInteraction);
        
        // Only hide if not interacting with dropdown
        if (!isDropdownInteraction) {
            dropdownHideTimeout = setTimeout(() => {
                if (!isDropdownInteraction) {
                    console.log('Hiding dropdown after blur delay');
                    hidePromptDropdown();
                } else {
                    console.log('Cancelling hide - dropdown interaction detected');
                }
            }, 150);
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('prompt-dropdown');
        const input = document.getElementById('prompt-input');
        
        if (dropdown && !dropdown.contains(e.target) && !input.contains(e.target)) {
            console.log('Clicked outside, hiding dropdown');
            isDropdownInteraction = false;
            if (dropdownHideTimeout) {
                clearTimeout(dropdownHideTimeout);
            }
            hidePromptDropdown();
        }
    });

    // Cancellation controller
    let currentAbortController = null;

    // Clipboard and fullscreen functionality
        document.getElementById('models-container').addEventListener('click', (event) => {
            const copyBtn = event.target.closest('.copy-btn');
            const fullscreenBtn = event.target.closest('.fullscreen-btn');
            
            // Handle matrix mode buttons
            if (currentMode === 'matrix') {
                if (copyBtn) {
                    const matrixIndex = copyBtn.getAttribute('data-matrix-index');
                    const matrixOutput = document.getElementById(`matrix-${matrixIndex}`);
                    
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = matrixOutput.textContent;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);

                    copyBtn.innerHTML = '‚úì';
                    setTimeout(() => {
                        copyBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                        `;
                    }, 1000);
                    return;
                }

                if (fullscreenBtn) {
                    const matrixIndex = fullscreenBtn.getAttribute('data-matrix-index');
                    const matrixOutput = document.getElementById(`matrix-${matrixIndex}`);
                    const matrixStats = document.getElementById(`matrix-stats-${matrixIndex}`);
                    
                    fullscreenContent.innerHTML = matrixOutput.innerHTML;
                    
                    const fullscreenModelName = document.getElementById('fullscreen-model-name');
                    const fullscreenModelStats = document.getElementById('fullscreen-model-stats');
                    const combinations = generateParameterMatrix(selectedModel);
                    
                    fullscreenModelName.textContent = `${selectedModel} - ${combinations[matrixIndex].displayLabel}`;
                    fullscreenModelStats.innerHTML = matrixStats.innerHTML;
                    
                    const fullscreenCopyBtn = fullscreenModal.querySelector('.copy-btn');
                    if (fullscreenCopyBtn) {
                        fullscreenCopyBtn.setAttribute('data-matrix-index', matrixIndex);
                    }
                    
                    fullscreenModal.classList.remove('hidden');
                    fullscreenModal.classList.add('opacity-100');
                    return;
                }
            }

                if (copyBtn) {
                    const modelName = copyBtn.getAttribute('data-model');
                    const modelOutput = document.getElementById(`model-${modelName}`);
                    
                    // Create a temporary textarea to copy text
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = modelOutput.textContent;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);

                    // Optional: Provide visual feedback
                    copyBtn.innerHTML = '‚úì';
                    setTimeout(() => {
                        copyBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                        `;
                    }, 1000);
                }

                if (fullscreenBtn) {
                    const modelName = fullscreenBtn.getAttribute('data-model');
                    const modelOutput = document.getElementById(`model-${modelName}`);
                    const modelNameLabel = document.querySelector(`label[class*="${modelName}"]`);
                    const modelStatsElement = document.getElementById(`model-stats-${modelName}`);
                    
                    // Set fullscreen content
                    fullscreenContent.innerHTML = modelOutput.innerHTML;
                    
                    // Set model name and stats
                    const fullscreenModelName = document.getElementById('fullscreen-model-name');
                    const fullscreenModelStats = document.getElementById('fullscreen-model-stats');
                    console.log('Opening fullscreen modal for model:', modelName);
                    console.log('Model output:', modelOutput.innerHTML);
                    
                    fullscreenModelName.textContent = modelNameLabel ? modelNameLabel.textContent : modelName;
                    fullscreenModelStats.innerHTML = modelStatsElement ? modelStatsElement.innerHTML : '';
                    
                    // Update copy button's data-model attribute
                    const fullscreenCopyBtn = fullscreenModal.querySelector('.copy-btn');
                    if (fullscreenCopyBtn) {
                        console.log('Found fullscreen copy button');
                        fullscreenCopyBtn.setAttribute('data-model', modelName);
                    } else {
                        console.error('Could not find fullscreen copy button');
                    }
                    
                    // Show modal
                    fullscreenModal.classList.remove('hidden');
                    fullscreenModal.classList.add('opacity-100');
                }
        });

            // Close fullscreen modal
            closeFullscreenBtn.addEventListener('click', () => {
                fullscreenModal.classList.add('hidden');
                fullscreenModal.classList.remove('opacity-100');
            });

            // Close modal when clicking outside the content
            fullscreenModal.addEventListener('click', (event) => {
                if (event.target === fullscreenModal) {
                    fullscreenModal.classList.add('hidden');
                    fullscreenModal.classList.remove('opacity-100');
                }
            });

            // Handle copy button click in fullscreen modal
            fullscreenModal.querySelector('.copy-btn').addEventListener('click', (event) => {
                console.log('Fullscreen copy button clicked');
                const modelName = event.target.closest('.copy-btn').getAttribute('data-model');
                const matrixIndex = event.target.closest('.copy-btn').getAttribute('data-matrix-index');
                console.log('Copying content for:', currentMode === 'matrix' ? `matrix-${matrixIndex}` : `model-${modelName}`);
                
                // Create a temporary textarea to copy text
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = fullscreenContent.textContent;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);

                // Visual feedback
                const copyBtn = event.target.closest('.copy-btn');
                copyBtn.innerHTML = '‚úì';
                setTimeout(() => {
                    copyBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                        </svg>
                    `;
                }, 1000);
            });

            // Load prompt history on page load
            loadPromptHistory();

            // Cancel button functionality
            cancelBtn.addEventListener('click', () => {
                if (currentAbortController) {
                    currentAbortController.abort();
                    
                    // Reset UI
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    cancelBtn.classList.add('hidden');

                    // Update model statuses
                    allModels.forEach(model => {
                        const textarea = document.getElementById(`model-${model.name}`);
                        const statsElement = document.getElementById(`model-stats-${model.name}`);
                        
                        if (textarea && textarea.innerHTML === 'Loading...') {
                            textarea.innerHTML = 'Cancelled';
                            textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-queued';
                            if (statsElement) statsElement.textContent = 'Cancelled';
                        }
                    });
                }
            });

            // Function to handle submission
            async function handleSubmission() {
                const prompt = promptInput.value.trim();
                if (!prompt) return;

                // Create a new abort controller for this submission
                currentAbortController = new AbortController();

                // Save prompt to history
                savePrompt(prompt);
                // Reload prompt history to update autocomplete
                loadPromptHistory();
                
                if (currentMode === 'matrix') {
                    await handleMatrixSubmission(prompt);
                } else {
                    await handleMultiModelSubmission(prompt);
                }
            }

            // Matrix mode submission
            async function handleMatrixSubmission(prompt) {
                // Disable submit button, show cancel button
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                cancelBtn.classList.remove('hidden');

                const combinations = generateParameterMatrix(selectedModel);
                const matrixResults = [];
                const selectedModelObj = allModels.find(m => m.name === selectedModel);

                // Clear previous results and set initial states
                combinations.forEach((combo, idx) => {
                    const textarea = document.getElementById(`matrix-${idx}`);
                    const statsElement = document.getElementById(`matrix-stats-${idx}`);
                    const matrixContainer = textarea.closest('.matrix-card');
                    
                    matrixContainer.classList.remove('fastest-model');
                    textarea.innerHTML = 'Queued';
                    textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-queued';
                    statsElement.textContent = '';
                });

                const processMatrixCellWithUI = async (combo, idx) => {
                    const textarea = document.getElementById(`matrix-${idx}`);
                    const statsElement = document.getElementById(`matrix-stats-${idx}`);
                    
                    textarea.innerHTML = 'Loading...';
                    textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-loading';

                    try {
                        const result = await queryModel(selectedModelObj, prompt, 0, currentAbortController?.signal, combo);
                        
                        if (currentAbortController?.signal?.aborted) {
                            textarea.innerHTML = 'Cancelled';
                            textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-queued';
                            return null;
                        }

                        const markdownContent = marked.parse(result.text);
                        
                        if (result.text.startsWith('Error') || result.text === 'Request cancelled') {
                            textarea.innerHTML = result.text;
                            textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-error';
                            textarea.closest('.matrix-card').classList.add('opacity-50', 'grayscale');
                            statsElement.textContent = 'Error';
                            matrixResults.push({ index: idx, duration: Infinity });
                            textarea.closest('.matrix-card').querySelector('.copy-btn').classList.add('hidden');
                            textarea.closest('.matrix-card').querySelector('.fullscreen-btn').classList.add('hidden');
                        } else {
                            textarea.innerHTML = markdownContent;
                            textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-completed';
                            textarea.closest('.matrix-card').classList.remove('opacity-50', 'grayscale');
                            
                            // Show copy and fullscreen buttons
                            const copyBtn = textarea.closest('.matrix-card').querySelector('.copy-btn');
                            const fullscreenBtn = textarea.closest('.matrix-card').querySelector('.fullscreen-btn');
                            copyBtn.classList.remove('hidden');
                            fullscreenBtn.classList.remove('hidden');
                            
                            // Calculate and display text statistics
                            const stats = calculateTextStatistics(result.text);
                            const pollenCost = calculatePollenCost(result.usage, result.pricing);
                            const costDisplay = pollenCost !== null ? `<br><span class="text-xs text-green-500">${formatPollenCost(pollenCost)}</span>` : '';
                            
                            statsElement.innerHTML = `
                                ${result.duration}ms | ${stats.characters}chr | ${stats.words}w
                                <br><span class="text-xs text-gray-400">
                                ${result.usage.prompt_tokens || 0} + ${result.usage.completion_tokens || 0} = ${result.usage.total_tokens || 0} tks
                                </span>${costDisplay}
                            `;
                            
                            matrixResults.push({ index: idx, duration: result.duration });
                        }
                    } catch (error) {
                        textarea.innerHTML = `Error: ${error.message}`;
                        textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-error';
                        statsElement.textContent = 'Error retrieving stats';
                        matrixResults.push({ index: idx, duration: Infinity });
                    }
                };

                // Concurrent processing with max 2 simultaneous requests
                const processBatches = async () => {
                    for (let i = 0; i < combinations.length; i += 2) {
                        const batch = combinations.slice(i, i + 2);
                        await Promise.all(batch.map((combo, batchIdx) => processMatrixCellWithUI(combo, i + batchIdx)));
                    }
                };

                await processBatches();

                // Highlight 3 fastest matrix cells
                const sortedResults = matrixResults
                    .filter(result => result.duration !== Infinity)
                    .sort((a, b) => a.duration - b.duration)
                    .slice(0, 3);

                sortedResults.forEach(result => {
                    const matrixContainer = document.querySelector(`[id="matrix-${result.index}"]`).closest('.matrix-card');
                    matrixContainer.classList.add('fastest-model');
                });

                // Re-enable submit button and hide cancel button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                cancelBtn.classList.add('hidden');
            }

            // Multi-model mode submission (original logic)
            async function handleMultiModelSubmission(prompt) {

                // Disable submit button, show cancel button
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                cancelBtn.classList.remove('hidden');
                
                // Get only enabled models
                const enabledModels = getEnabledModels();
                
                if (enabledModels.length === 0) {
                    alert('No models enabled! Please enable at least one model by clicking on a disabled model card.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    cancelBtn.classList.add('hidden');
                    return;
                }

                // Clear previous results and set initial states for ALL models
                const modelResults = [];
                allModels.forEach(model => {
                    const textarea = document.getElementById(`model-${model.name}`);
                    const statsElement = document.getElementById(`model-stats-${model.name}`);
                    const modelContainer = textarea.closest('.border');
                    
                    // Remove any previous fastest model highlights
                    modelContainer.classList.remove('fastest-model');
                    
                    // Set initial state based on enabled/disabled
                    if (disabledModels.has(model.name)) {
                        textarea.innerHTML = 'Disabled - Click card to enable';
                        textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-queued';
                        statsElement.textContent = '';
                    } else {
                        textarea.innerHTML = 'Queued';
                        textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-queued';
                        statsElement.textContent = '';
                    }
                });

        const processModelWithUI = async (model) => {
                    const textarea = document.getElementById(`model-${model.name}`);
                    const statsElement = document.getElementById(`model-stats-${model.name}`);
                    
                    // Update status to loading
                    textarea.innerHTML = 'Loading...';
                    textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-loading';

                    try {
                        // Pass the abort signal to queryModel
                        const result = await queryModel(model, prompt, 0, currentAbortController?.signal);
                        
                        // If cancelled, skip processing
                        if (currentAbortController?.signal?.aborted) {
                            textarea.innerHTML = 'Cancelled';
                            textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-queued';
                            return null;
                        }

                        const markdownContent = marked.parse(result.text);
                        
                if (result.text.startsWith('Error') || result.text === 'Request cancelled') {
                            textarea.innerHTML = result.text;
                            textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-error';
                            textarea.closest('.border').classList.add('opacity-50', 'grayscale');
                            statsElement.textContent = 'Error';
                            modelResults.push({ model: model.name, duration: Infinity });
                            textarea.closest('.border').querySelector('.copy-btn').classList.add('hidden');
                            textarea.closest('.border').querySelector('.fullscreen-btn').classList.add('hidden');
                } else {
                    textarea.innerHTML = markdownContent;
                    textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-completed';
                    textarea.closest('.border').classList.remove('opacity-50', 'grayscale');
                    
                    // Show copy and fullscreen buttons
                    const copyBtn = textarea.closest('.border').querySelector('.copy-btn');
                    const fullscreenBtn = textarea.closest('.border').querySelector('.fullscreen-btn');
                    copyBtn.classList.remove('hidden');
                    fullscreenBtn.classList.remove('hidden');
                    
                    // Calculate and display text statistics (no parameters in multi-model view)
                    const stats = calculateTextStatistics(result.text);
                    const pollenCost = calculatePollenCost(result.usage, result.pricing);
                    const costDisplay = pollenCost !== null ? `<br><span class="text-xs text-green-500">${formatPollenCost(pollenCost)}</span>` : '';
                    
                    statsElement.innerHTML = `
                        ${result.duration}ms | ${stats.characters}chr | ${stats.words}w
                        <br><span class="text-xs text-gray-400">
                        ${result.usage.prompt_tokens || 0} + ${result.usage.completion_tokens || 0} = ${result.usage.total_tokens || 0} tks
                        </span>${costDisplay}
                    `;
                    
                    modelResults.push({ model: model.name, duration: result.duration });
                }
            } catch (error) {
                        textarea.innerHTML = `Error: ${error.message}`;
                        textarea.className = textarea.className.replace(/model-status-\w+/g, '') + ' model-status-error';
                        statsElement.textContent = 'Error retrieving stats';
                        modelResults.push({ model: model.name, duration: Infinity });
                    }
                };

                // Concurrent processing with max 2 simultaneous requests (only enabled models)
                const processBatches = async () => {
                    for (let i = 0; i < enabledModels.length; i += 2) {
                        const batch = enabledModels.slice(i, i + 2);
                        await Promise.all(batch.map(processModelWithUI));
                    }
                };

                await processBatches();

                // Highlight 3 fastest models (only from enabled models)
                const sortedResults = modelResults
                    .filter(result => result.duration !== Infinity)
                    .sort((a, b) => a.duration - b.duration)
                    .slice(0, 3);

                sortedResults.forEach(result => {
                    const modelContainer = document.querySelector(`[id="model-${result.model}"]`).closest('.border');
                    modelContainer.classList.add('fastest-model');
                });

                // Re-enable submit button and hide cancel button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                cancelBtn.classList.add('hidden');
            }

            // Click event for submit button
            submitBtn.addEventListener('click', handleSubmission);

            // Enter key support for input
            promptInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent default form submission
                    handleSubmission();
                }
            });

            // BYOP Modal functionality
            const byopBtn = document.getElementById('byop-btn');
            const byopModal = document.getElementById('byop-modal');
            const closeBYOPBtn = document.getElementById('close-byop-btn');
            const oauthConnectBtn = document.getElementById('oauth-connect-btn');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const clearApiKeyBtn = document.getElementById('clear-api-key-btn');
            const resetApiKeyBtn = document.getElementById('reset-api-key-btn');
            const manualApiKeyInput = document.getElementById('manual-api-key');

            // Update API key display
            async function updateApiKeyStatus() {
                const apiKey = getApiKey();
                const keyDisplay = document.getElementById('key-display');
                const keyTypeBadge = document.getElementById('key-type-badge');
                const balanceDisplay = document.getElementById('balance-display');
                
                // Mask the key
                const maskedKey = apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4);
                keyDisplay.textContent = maskedKey;
                
                // Determine key type
                const isDefault = apiKey === DEFAULT_API_KEY;
                const isSecret = apiKey.startsWith('sk_');
                const isPublishable = apiKey.startsWith('pk_');
                
                if (isDefault) {
                    keyTypeBadge.textContent = 'Default Key';
                    keyTypeBadge.className = 'text-xs px-2 py-1 rounded bg-blue-500 text-white';
                } else if (isSecret) {
                    keyTypeBadge.textContent = 'Secret Key';
                    keyTypeBadge.className = 'text-xs px-2 py-1 rounded bg-green-500 text-white';
                } else if (isPublishable) {
                    keyTypeBadge.textContent = 'Publishable Key';
                    keyTypeBadge.className = 'text-xs px-2 py-1 rounded bg-purple-500 text-white';
                } else {
                    keyTypeBadge.textContent = 'Custom Key';
                    keyTypeBadge.className = 'text-xs px-2 py-1 rounded bg-gray-500 text-white';
                }
                
                // Try to fetch balance
                try {
                    const balanceResponse = await axios.get('https://gen.pollinations.ai/account/balance', {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });
                    balanceDisplay.textContent = `Balance: ${balanceResponse.data.balance} pollen`;
                } catch (error) {
                    balanceDisplay.textContent = 'Balance: Unable to fetch (may require account:balance permission)';
                }
            }

            // Show BYOP modal
            byopBtn.addEventListener('click', async () => {
                byopModal.classList.remove('hidden');
                await updateApiKeyStatus();
            });

            // Close BYOP modal
            closeBYOPBtn.addEventListener('click', () => {
                byopModal.classList.add('hidden');
            });

            // Close modal when clicking outside
            byopModal.addEventListener('click', (event) => {
                if (event.target === byopModal) {
                    byopModal.classList.add('hidden');
                }
            });

            // OAuth connect
            oauthConnectBtn.addEventListener('click', () => {
                const redirectUrl = encodeURIComponent(window.location.href);
                const authUrl = `https://enter.pollinations.ai/authorize?redirect_url=${redirectUrl}`;
                window.location.href = authUrl;
            });

            // Manual API key save
            saveApiKeyBtn.addEventListener('click', () => {
                const newKey = manualApiKeyInput.value.trim();
                if (newKey && (newKey.startsWith('pk_') || newKey.startsWith('sk_'))) {
                    localStorage.setItem('userApiKey', newKey);
                    manualApiKeyInput.value = '';
                    updateApiKeyStatus();
                    alert('API key saved successfully! Your key is now stored in browser storage and will be used for all requests.');
                    updateBYOPButton();
                } else {
                    alert('Invalid API key format. Keys should start with pk_ or sk_');
                }
            });

            // Clear API key from browser storage
            clearApiKeyBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear your API key from browser storage? This will revert to the default key.')) {
                    localStorage.removeItem('userApiKey');
                    updateApiKeyStatus();
                    updateBYOPButton();
                    alert('Your API key has been cleared from browser storage. Now using default key.');
                }
            });

            // Reset to default key
            resetApiKeyBtn.addEventListener('click', () => {
                if (confirm('Reset to default key? This will clear your stored API key.')) {
                    localStorage.removeItem('userApiKey');
                    updateApiKeyStatus();
                    updateBYOPButton();
                    alert('Reset to default key.');
                }
            });

            // Update BYOP button appearance based on key status
            function updateBYOPButton() {
                const apiKey = getApiKey();
                const isCustomKey = apiKey !== DEFAULT_API_KEY;
                if (isCustomKey) {
                    byopBtn.classList.add('ring-2', 'ring-green-400');
                    byopBtn.title = 'Using your API key ‚úì';
                } else {
                    byopBtn.classList.remove('ring-2', 'ring-green-400');
                    byopBtn.title = 'Bring Your Own Pollen - Use your API key';
                }
            }
            updateBYOPButton();

            // Toggle all models button
            const toggleAllBtn = document.getElementById('toggle-all-btn');
            toggleAllBtn.addEventListener('click', () => {
                if (disabledModels.size === 0) {
                    // Disable all models
                    allModels.forEach(model => {
                        disabledModels.add(model.name);
                        updateModelCardState(model.name);
                    });
                    // Update to unchecked circle icon
                    toggleAllBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>All</span>
                    `;
                    saveDisabledModels();
                } else {
                    // Enable all models
                    disabledModels.clear();
                    allModels.forEach(model => {
                        updateModelCardState(model.name);
                    });
                    // Update to checked circle icon
                    toggleAllBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>All</span>
                    `;
                    saveDisabledModels();
                }
            });
        });
    </script>
</body>
</html>
